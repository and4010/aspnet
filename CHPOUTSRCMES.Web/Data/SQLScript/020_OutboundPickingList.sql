CREATE FUNCTION OutboundPickingList (@SHIPMENT_NUMBER NVARCHAR(30))
RETURNS @myTable TABLE(
	SUB_ID [bigint]  NULL,
	PAGE_ID  [bigint]  NULL,
	VISABLE [bigint]  NULL,
	GROUP_ID [bigint]  NULL,
	SHIPMENT_NUMBER [nvarchar](30)  NULL,
	ORGANIZATION_CODE [nvarchar](3) NULL,
	SUBINVENTORY_CODE [nvarchar](20) NULL,
	LOCATOR_CODE [nvarchar](163) NULL,
	TRANSFER_ORGANIZATION_CODE [nvarchar](3) NULL,
	TRANSFER_SUBINVENTORY_CODE [nvarchar](20) NULL,
	TRANSFER_LOCATOR_CODE [nvarchar](163) NULL,
	PAPER_TYPE [nvarchar](30)  NULL,
	BASIC_WEIGHT [nvarchar](30)  NULL,
	SPECIFICATION [nvarchar](30)  NULL,
	GRAIN_DIRECTION [nvarchar](30) NULL,
	PACKING_TYPE [nvarchar](30) NULL,
	REQUESTED_SECONDARY_QUANTITY [decimal](30, 10) NULL,
	REQUESTED_SECONDARY_UOM [nvarchar](3) NULL,
	REQUESTED_PRIMARY_QUANTITY [decimal](30, 10)  NULL,
	REQUESTED_PRIMARY_UOM [nvarchar](3)  NULL,
	ROLL_REAM_QTY [bigint] NULL
)
AS
BEGIN
--定義Cursor並打開
DECLARE MyCursor Cursor FOR --宣告，名稱為MyCursor

SELECT
CEILING(d.ROLL_REAM_QTY / 2) AS ROW_COUNT,
d.ROLL_REAM_QTY AS ROLL_REAM_QTY
FROM TRF_DETAIL_T d
join TRF_HEADER_T h  on h.TRANSFER_HEADER_ID = d.TRANSFER_HEADER_ID
WHERE h.SHIPMENT_NUMBER = @SHIPMENT_NUMBER

Open MyCursor 

--print @@CURSOR_rows --查看總筆數

DECLARE @tempTable TABLE
(
PAGE_ID  [bigint]  NULL,
GROUP_ID [bigint]  NULL,
VISABLE [bigint]  NULL,
ROLL_REAM_QTY [bigint] NULL
)

--定義ID變數
--declare @id bigint --用來存放ID的變數
declare @rowCount bigint --ROW數
declare @ROLL_REAM_QTY bigint --板捲數
DECLARE @groupId INT = 1 --目前次數
DECLARE @pageId INT = 1, @seqId INT = 1 --目前次數
DECLARE @pageCount INT = 6

--開始迴圈跑Cursor Start
Fetch NEXT FROM MyCursor INTO @rowCount, @ROLL_REAM_QTY 
While @@FETCH_STATUS = 0
	BEGIN
	DECLARE @Num INT  --目前ROW數
	SET @Num =1
	WHILE @Num <= @rowCount + 1
		BEGIN
		IF @Num = 1 --每個群組的第一筆
		BEGIN
			IF (@seqId = @pageCount and @pageId = 1)
			BEGIN
				set @pageId = @pageId + 1
				set @pageCount = 5
				SET @seqId = 0
			END
			ELSE IF (@seqId = (@pageCount - 1))
			BEGIN
				set @pageId = @pageId + 1
				set @pageCount = 5
				SET @seqId = 0
			END
			INSERT INTO @tempTable (PAGE_ID, GROUP_ID, VISABLE, ROLL_REAM_QTY) VALUES (@pageId, @groupId, 1, @ROLL_REAM_QTY)
		END
		ELSE
		BEGIN
			IF (@seqId >= @pageCount)
			BEGIN
				set @pageId = @pageId + 1
				set @pageCount = 5
				SET @seqId = 0
				
			END
			INSERT INTO @tempTable (PAGE_ID, GROUP_ID, VISABLE, ROLL_REAM_QTY) VALUES (@pageId, @groupId, 0, @ROLL_REAM_QTY)
		END
		--設定目前次數+1
		SET @Num = @Num + 1
		SET @seqId = @seqId + 1
	END
	SET @groupId = @groupId + 1
Fetch NEXT FROM MyCursor INTO @rowCount, @ROLL_REAM_QTY
END
--開始迴圈跑Cursor End

--關閉&釋放cursor
CLOSE MyCursor
DEALLOCATE MyCursor

--select * from @tempTable
INSERT @myTable
SELECT  ROW_NUMBER() OVER(ORDER BY A.GROUP_ID) AS SUB_ID,
B.PAGE_ID, B.VISABLE, A.*,B.ROLL_REAM_QTY
 FROM 
(
SELECT
ROW_NUMBER() OVER(ORDER BY h.TRANSFER_HEADER_ID) AS GROUP_ID,
h.SHIPMENT_NUMBER AS SHIPMENT_NUMBER,
h.ORGANIZATION_CODE AS ORGANIZATION_CODE,
h.SUBINVENTORY_CODE AS SUBINVENTORY_CODE,
h.LOCATOR_CODE AS LOCATOR_CODE,
h.TRANSFER_ORGANIZATION_CODE AS TRANSFER_ORGANIZATION_CODE,
h.TRANSFER_SUBINVENTORY_CODE AS TRANSFER_SUBINVENTORY_CODE,
h.TRANSFER_LOCATOR_CODE AS TRANSFER_LOCATOR_CODE,
i.CATALOG_ELEM_VAL_020 AS PAPER_TYPE,
i.CATALOG_ELEM_VAL_040 AS BASIC_WEIGHT,
i.CATALOG_ELEM_VAL_050 AS SPECIFICATION,
i.CATALOG_ELEM_VAL_100 AS GRAIN_DIRECTION,
d.PACKING_TYPE AS PACKING_TYPE,
d.REQUESTED_SECONDARY_QUANTITY AS REQUESTED_SECONDARY_QUANTITY,
d.REQUESTED_SECONDARY_UOM AS REQUESTED_SECONDARY_UOM,
d.REQUESTED_PRIMARY_QUANTITY AS REQUESTED_PRIMARY_QUANTITY,
d.REQUESTED_PRIMARY_UOM AS REQUESTED_PRIMARY_UOM
FROM TRF_HEADER_T h
INNER JOIN TRF_DETAIL_T d on h.TRANSFER_HEADER_ID = d.TRANSFER_HEADER_ID
join ORG_ITEMS_T o on h.ORGANIZATION_ID = o.ORGANIZATION_ID
join ITEMS_T i on o.INVENTORY_ITEM_ID = i.INVENTORY_ITEM_ID AND d.INVENTORY_ITEM_ID = i.INVENTORY_ITEM_ID AND i.CONTROL_FLAG <> 'D'

WHERE h.SHIPMENT_NUMBER = @SHIPMENT_NUMBER
) A
left JOIN @tempTable B ON A.GROUP_ID = B.GROUP_ID
RETURN
END
GO