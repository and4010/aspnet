-- =============================================
-- Author:		Polo Lin
-- Create date: 2020/09/16
-- Description:	SOA XXIF_CHP_P210_IN_MMT_INGR_ST 資料上傳
-- 未解決.. RXD  捲筒理論重
-- =============================================
CREATE PROCEDURE [dbo].[SP_P210_OspStStage1Upload]
	@ospHeaderId BIGINT,
	@code INT OUTPUT,
	@message VARCHAR(500) OUTPUT,
	@user VARCHAR(128)
AS
BEGIN

	DECLARE @table TABLE (
		PROCESS_CODE VARCHAR(20)
		, SERVER_CODE VARCHAR(20)
		, BATCH_ID VARCHAR(20)
		, BATCH_LINE_ID BIGINT
		, BATCH_NO VARCHAR(32) 
	) 

	DECLARE @success INT = 0
	DECLARE @count INT = 0
	SELECT @message = 'OSP_HEADER_ID:' + CONVERT(varchar, @ospHeaderId)

	DECLARE @txnDate DATETIME = GETDATE()
	DECLARE @processCode VARCHAR(20) = 'XXIFP210', @serverCode VARCHAR(20) = 'FTY'
	DECLARE @batchId VARCHAR(20) = FORMAT(@txnDate, 'yyyyMMddHHmmssffffff')
	DECLARE @previousRxId BIGINT = 0
	
	BEGIN TRY
		
		SELECT TOP 1 @previousRxId = I.RXID FROM OSP_SOA_S1_T S 
		JOIN XXIF_CHP_P210_IN_MMT_INGR_ST I ON I.PROCESS_CODE = S.PROCESS_CODE AND I.SERVER_CODE = S.SERVER_CODE AND I.BATCH_ID = S.BATCH_ID
		WHERE S.OSP_HEADER_ID = @ospHeaderId AND S.STATUS_CODE = 'R'

		IF(@previousRxId <= 0)
		BEGIN
			SET @previousRxId = NULL
		END

		--取出待處理項目
		SET @success = @success + 1

		INSERT INTO XXIF_CHP_P210_IN_MMT_INGR_ST (
			PROCESS_CODE, SERVER_CODE, BATCH_ID, BATCH_LINE_ID, STATUS_CODE
			, ERROR_MSG, ORGCODE, RXID, PREVIOUS_RXID, BATCH_NO
			, ITEM_NO, SUBINVENTORY_CODE, LOCATOR, TRANSACTION_QUANTITY, TRANSACTION_UOM
			, SECONDARY_TRANSACTION_QUANTITY, SECONDARY_UOM_CODE, TRANSACTION_DATE, LOT_NUMBER, STATUS
			, TRANSACTION_ID, ATTRIBUTE1, ATTRIBUTE2, ATTRIBUTE3, ATTRIBUTE4
			, ATTRIBUTE5, ATTRIBUTE6, ATTRIBUTE7, ATTRIBUTE8, ATTRIBUTE9
			, ATTRIBUTE10, ATTRIBUTE11, ATTRIBUTE12, ATTRIBUTE13, ATTRIBUTE14
			, ATTRIBUTE15, REQUEST_ID, CREATED_BY, CREATION_DATE, LAST_UPDATED_BY
			, LAST_UPDATE_DATE, LAST_UPDATE_LOGIN
		)
		OUTPUT inserted.PROCESS_CODE, inserted.SERVER_CODE, inserted.BATCH_ID, inserted.BATCH_LINE_ID, inserted.BATCH_NO
			INTO @table (PROCESS_CODE, SERVER_CODE, BATCH_ID, BATCH_LINE_ID, BATCH_NO)
		SELECT
			@processCode, @serverCode, @batchId, ROW_NUMBER() OVER (ORDER BY (SELECT 1)), NULL
			, NULL, H.ORGANIZATION_CODE, D.OSP_DETAIL_IN_HT_ID, CASE WHEN @previousRxId > 0 THEN @previousRxId ELSE NULL END, BATCH_NO
			, D.INVENTORY_ITEM_NUMBER, D.SUBINVENTORY, D.LOCATOR_CODE, P.PRIMARY_QUANTITY, P.PRIMARY_UOM
			, P.SECONDARY_QUANTITY, P.SECONDARY_UOM, @txnDate, NULL, 'C'
			, NULL, NULL, CASE I.CATALOG_ELEM_VAL_070 WHEN  '捲筒' THEN P.LOT_NUMBER ELSE NULL END, CASE I.CATALOG_ELEM_VAL_070 WHEN  '捲筒' THEN '' ELSE NULL END, NULL
			, NULL, NULL, NULL, NULL, NULL
			, NULL, NULL, NULL, NULL, NULL
			, NULL, NULL, -1, P.CREATION_DATE, -1
			, ISNULL(P.LAST_UPDATE_DATE, P.CREATION_DATE), -1
		FROM OSP_HEADER_T H 
		JOIN OSP_DETAIL_IN_HT D ON D.OSP_HEADER_ID = H.OSP_HEADER_ID
		JOIN OSP_PICKED_IN_HT P ON P.OSP_DETAIL_IN_ID = D.OSP_DETAIL_IN_ID
		JOIN ITEMS_T I ON I.INVENTORY_ITEM_ID = P.INVENTORY_ITEM_ID
		WHERE H.OSP_HEADER_ID = @ospHeaderId
		ORDER BY D.PROCESS_CODE, D.SERVER_CODE, D.BATCH_ID, D.BATCH_LINE_ID
		
		IF (@@ROWCOUNT <= 0 OR @@ERROR <> 0)
		BEGIN
			SET @message = 'PROCESS_CODE:' + @processCode + ' SERVER_CODE:' + @serverCode + ' BATCH_ID:' 
			+ @batchId + ' OSP_HEADER_ID:' + CONVERT(varchar, @ospHeaderId) + ' 上傳生產批物料耗用失敗'
			RAISERROR(@message, 16, @success)
		END

		INSERT INTO XXIF_CHP_CONTROL_ST (
			PROCESS_CODE, SERVER_CODE, BATCH_ID, ROW_NUM, PROCESS_DATE
			, REQUEST_ID, STATUS_CODE, ERROR_MSG, SOA_PULLING_FLAG, SOA_ERROR_MSG
			, SOA_PROCESS_CODE, CREATED_BY, CREATION_DATE, LAST_UPDATED_BY, LAST_UPDATE_DATE
			, LAST_UPDATE_LOGIN
		)
		SELECT 
			C.PROCESS_CODE, C.SERVER_CODE, C.BATCH_ID, COUNT(*) AS ROW_NUM, @txnDate
			, NULL, NULL, NULL, 'In-W', NULL
			, NULL, -1, MAX(C.CREATION_DATE), -1, MAX(C.LAST_UPDATE_DATE)
			, -1
		FROM XXIF_CHP_P210_IN_MMT_INGR_ST C
		JOIN @table T ON T.PROCESS_CODE = C.PROCESS_CODE AND T.SERVER_CODE = C.SERVER_CODE AND T.BATCH_ID = C.BATCH_ID AND T.BATCH_LINE_ID = C.BATCH_LINE_ID
		GROUP BY C.PROCESS_CODE, C.SERVER_CODE, C.BATCH_ID

		IF (@@ROWCOUNT <= 0 OR @@ERROR <> 0)
		BEGIN
			SET @message = 'PROCESS_CODE:' + @processCode + ' SERVER_CODE:' + @serverCode + ' BATCH_ID:' 
			+ @batchId + ' OSP_HEADER_ID:' + CONVERT(varchar, @ospHeaderId) + ' 寫入 XXIF_CHP_CONTROL_ST 失敗'
			RAISERROR(@message, 16, @success)
		END

		INSERT INTO OSP_SOA_S1_T (
			OSP_HEADER_ID, PROCESS_CODE, SERVER_CODE, BATCH_ID, STATUS_CODE
			, CREATED_BY, CREATION_DATE, LAST_UPDATE_BY, LAST_UPDATE_DATE
		) 
		SELECT 
			@ospHeaderId, PROCESS_CODE, SERVER_CODE, BATCH_ID, NULL
			, @user, @txnDate, NULL, NULL
		FROM @table 
		GROUP BY PROCESS_CODE, SERVER_CODE, BATCH_ID

		IF(@@ROWCOUNT <= 0 OR @@ERROR <> 0)
		BEGIN
			SET @message = @message + ' 更新 OSP_SOA_T 錯誤'
			RAISERROR(@message, 16, @success)
		END
		
		SET @code = 0
		SET @message = ''
		
	END TRY
	BEGIN CATCH
		SET @code = -1 * @success
		SET @message = CAST(@success AS VARCHAR(2)) + ':' + ERROR_MESSAGE()
	END CATCH

END

